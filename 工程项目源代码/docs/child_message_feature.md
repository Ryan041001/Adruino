# 子女消息识别功能说明

## 功能概述

本系统新增了智能识别子女发送消息中时间提醒项目的功能。当子女通过 Web 界面或其他方式发送消息时，系统会自动分析消息内容，如果发现包含时间提醒信息，会自动添加到提醒系统中，并通过语音播报确认。

## 功能特点

### 1. 智能消息识别

- 自动识别子女发送的关怀消息
- 区分普通消息和包含提醒内容的消息
- 支持多种表达方式的时间提醒

### 2. 时间提醒提取

- 支持相对时间："明天"、"后天"、"1 小时后"、"30 分钟后"
- 支持具体时间："明天下午 3 点"、"后天上午 9 点"
- 支持口语化表达："明天早上"、"明天晚上"

### 3. 语音确认反馈

- 成功识别提醒后，系统会语音播报确认信息
- 重复一遍提醒内容，表示添加成功
- 对于普通消息，正常播报消息内容

## 支持的消息格式

### 提醒类消息示例

```
✅ "妈妈记得明天下午3点吃药"
✅ "爸爸别忘了后天上午去医院体检"
✅ "记得明天早上8点锻炼身体"
✅ "妈妈要记得每天喝水"
✅ "别忘了1小时后吃药"
✅ "30分钟后提醒我休息"
```

### 普通消息示例

```
📝 "今天天气很好，注意保暖"
📝 "妈妈，我今天会晚点回家"
📝 "工作顺利，不用担心"
```

## 识别关键词

### 提醒关键词

- 基础词汇：提醒、记得、别忘、到时候、叫、通知、告诉
- 关怀表达：妈妈记得、爸爸记得、妈妈别忘、爸爸别忘、妈妈要、爸爸要

### 时间表达

- 相对时间：明天、后天、今天、X 小时后、X 分钟后
- 具体时间：上午、下午、晚上、早上、X 点
- 时间修饰：一、二、三...十、半

### 任务动作

- 医疗：吃药、服药、用药、看医生、去医院、体检、检查
- 生活：买菜、购物、做饭、锻炼、运动、散步、喝水、休息、睡觉
- 其他：洗澡、洗头、打电话、联系

## 系统响应流程

### 1. 消息接收

```
子女发送消息 → Web服务器接收 → 调用消息回调函数
```

### 2. 消息分析

```
消息内容 → 语音助手分析 → 意图识别 → 时间提取 → 任务提取
```

### 3. 提醒处理

```
提醒信息 → 添加到提醒管理器 → 设置定时任务 → 语音确认播报
```

### 4. 普通消息处理

```
普通消息 → 语音播报 → 界面显示 → 日志记录
```

## 语音反馈示例

### 提醒类消息反馈

```
输入："妈妈记得明天下午3点吃药"
输出："收到小明的提醒消息：吃药。好的，我会在明天15:00提醒您吃药。"
```

### 普通消息反馈

```
输入："今天天气很好，注意保暖"
输出："收到小明的消息：今天天气很好，注意保暖"
```

## 技术实现

### 核心组件

1. **VoiceAssistant.process_child_message()**

   - 处理子女消息的主要方法
   - 调用意图识别和时间解析
   - 返回处理结果

2. **VoiceAssistant.parse_intent()**

   - 使用 LLM 进行语义分析
   - 支持多种表达方式
   - 提取时间和任务信息

3. **主程序消息回调增强**
   - 集成子女消息处理
   - 自动添加提醒到系统
   - 错误处理和降级方案

### 关键特性

- **智能降级**：LLM 解析失败时使用关键词匹配
- **错误恢复**：处理异常时保证系统稳定运行
- **多重验证**：确保提取的时间和任务信息准确
- **用户友好**：语音反馈清晰明确

## 使用方法

### 1. 通过 Web 界面发送消息

1. 打开 Web 管理界面
2. 在消息发送框中输入内容
3. 填写发送者姓名
4. 点击发送
5. 系统自动识别并处理

### 2. 消息格式建议

- 明确表达时间：使用"明天下午 3 点"而不是"下午"
- 清晰描述任务：使用"吃药"而不是"那个事情"
- 包含关键词：使用"记得"、"别忘"等提醒词汇

## 注意事项

1. **时间准确性**：系统会根据当前时间计算提醒时间，请确保设备时间正确
2. **网络依赖**：LLM 解析需要网络连接，离线时使用关键词匹配
3. **语言支持**：主要支持中文，英文支持有限
4. **提醒限制**：系统有最大提醒数量限制，超出时会提示

## 测试验证

运行测试脚本验证功能：

```bash
python test_child_message.py
```

测试覆盖：

- ✅ 子女提醒消息识别
- ✅ 时间解析准确性
- ✅ 任务提取正确性
- ✅ 普通消息处理
- ✅ 语音反馈功能
- ✅ 错误处理机制

## 更新日志

### v1.0 (2024-12-21)

- ✨ 新增子女消息智能识别功能
- ✨ 支持多种时间表达方式
- ✨ 增强任务内容提取能力
- ✨ 优化语音反馈机制
- 🐛 修复消息处理异常问题
- 📝 完善文档和测试用例
